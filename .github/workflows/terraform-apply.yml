name: Terraform Apply

on: workflow_dispatch

permissions:
  id-token: write
  contents: read

jobs:
  plan:
    runs-on: ubuntu-latest
    environment: NygDevAzure
    env:
      ARM_USE_CLI: "true"
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: 'Az CLI login'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: 'Install Terraform'
        run: |
          TERRAFORM_VERSION=$(curl -s https://checkpoint-api.hashicorp.com/v1/check/terraform | jq -r .current_version)
          curl -fsSL "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" -o terraform.zip
          unzip -o terraform.zip -d /usr/local/bin/
          terraform version

      - name: 'Retrieve Home IP from Key Vault'
        run: |
          HOME_IP=$(az keyvault secret show \
            --vault-name ${{ secrets.AZURE_KEYVAULT_NAME }} \
            --name HomeIP \
            --query value \
            --output tsv)
          echo "::add-mask::$HOME_IP"
          echo "HOME_IP=$HOME_IP" >> $GITHUB_ENV

      - name: 'Retrieve SSH Public Key'
        run: |
          SSH_KEY=$(az sshkey show \
            --resource-group FreeServices \
            --name NygDev \
            --query publicKey \
            --output tsv)
          echo "SSH_PUBLIC_KEY<<EOF" >> $GITHUB_ENV
          echo "$SSH_KEY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 'Find Latest Ubuntu Daily Offer'
        run: |
          LATEST_OFFER=$(az vm image list-offers \
            --publisher Canonical \
            --location norwayeast \
            --query "[?contains(name, 'daily') && contains(name, 'ubuntu-')].name" \
            --output tsv \
            | sort -V \
            | tail -1)
          echo "UBUNTU_OFFER=$LATEST_OFFER" >> $GITHUB_ENV

      - name: 'Terraform Init'
        working-directory: terraform
        run: terraform init

      - name: 'Terraform Plan'
        working-directory: terraform
        run: |
          terraform plan \
            -var="home_ip=$HOME_IP" \
            -var="ssh_public_key=$SSH_PUBLIC_KEY" \
            -var="ubuntu_offer=$UBUNTU_OFFER" \
            -var="admin_username=${{ secrets.AZURE_VM_USERNAME }}" \
            -out=tfplan

      - name: 'Upload Plan'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: terraform/tfplan
          retention-days: 1

  apply:
    runs-on: ubuntu-latest
    needs: plan
    environment: NygDevAzure
    env:
      ARM_USE_CLI: "true"
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: 'Az CLI login'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: 'Install Terraform'
        run: |
          TERRAFORM_VERSION=$(curl -s https://checkpoint-api.hashicorp.com/v1/check/terraform | jq -r .current_version)
          curl -fsSL "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" -o terraform.zip
          unzip -o terraform.zip -d /usr/local/bin/
          terraform version

      - name: 'Download Plan'
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: terraform/

      - name: 'Terraform Init'
        working-directory: terraform
        run: terraform init

      - name: 'Terraform Apply'
        working-directory: terraform
        run: terraform apply -auto-approve tfplan
